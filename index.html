<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LunarDomain: Decentralized .lunar Sites</title>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body { font-family: monospace; background: #111; color: #fff; }
    input, button, textarea { font-size: 1em; }
    #site-viewer { margin-top: 2em; background: #222; padding: 1em; border-radius: 8px; min-height: 200px; }
    #register-form { margin-top: 2em; background: #222; padding: 1em; border-radius: 8px; }
    a, a:visited { color: #89f; }
    .info { color: #aaa; font-size: small; }
    #mirror-btn, #open-newtab-btn { margin-top: 1em; }
    iframe { width: 100%; height: 400px; border: none; background: #fff; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ LunarDomain .lunar with WebTorrent</h1>
  <form id="domain-form">
    <input id="domain-input" placeholder="Enter .lunar domain (e.g. mysite.lunar)" required />
    <button type="submit">Visit</button>
  </form>
  <div id="site-viewer">Enter a .lunar domain to get started.</div>

  <form id="register-form">
    <h3>Register your .lunar domain</h3>
    <input id="reg-domain" placeholder="mysite.lunar" required />
    <textarea id="reg-html" placeholder="Your site HTML" required style="width:100%;height:100px;"></textarea><br>
    <button type="submit">Register</button>
    <div class="info">(This seeds your site HTML via WebTorrent and maps your .lunar domain to your magnet URI. Others will fetch your HTML via WebTorrent!)</div>
  </form>

  <div class="info" style="margin-top:2em;">
    <b>How it works:</b> When you register, your HTML is seeded as a WebTorrent and the magnet URI is published to GUN. Visitors fetch your HTML via WebTorrent. Anyone can "mirror" a site, seeding it themselves and adding their magnet link as a mirror.<br>
    <b>Now, you can also open .lunar sites in a new tab as a true proxy!</b>
  </div>

  <script>
    // GUN for lightweight metadata (magnet URIs, mirrors)
    const gun = Gun();

    // Generate a pseudo-MAC/peer ID for this device (browser-unique)
    function getPseudoMAC() {
      let mac = localStorage.getItem('pseudo_mac');
      if (!mac) {
        mac = 'MAC-' + Math.random().toString(36).substr(2,12);
        localStorage.setItem('pseudo_mac', mac);
      }
      return mac;
    }
    const myMAC = getPseudoMAC();

    // WebTorrent client
    const client = new WebTorrent();

    // Map domain -> owner MAC
    function setDomainOwner(domain, mac) {
      gun.get('lunar_domains').get(domain).put({ mac });
    }
    function getDomainOwner(domain, cb) {
      gun.get('lunar_domains').get(domain).once(data => cb(data ? data.mac : null));
    }

    // Map MAC -> magnet URI
    function saveMagnet(mac, magnet) {
      gun.get('lunar_uris').get(mac).put({ magnet });
    }
    function loadMagnet(mac, cb) {
      gun.get('lunar_uris').get(mac).once(data => cb(data ? data.magnet : null));
    }

    // Mirroring: domain -> set of MACs
    function addMirror(domain, mac) {
      gun.get('lunar_mirrors').get(domain).get(mac).put(true);
    }
    function getMirrors(domain, cb) {
      gun.get('lunar_mirrors').get(domain).once(data => {
        if (!data) return cb([]);
        const macs = Object.keys(data).filter(k => data[k] === true && !k.startsWith('_'));
        cb(macs);
      });
    }

    // Register domain handler, and seed HTML as torrent
    document.getElementById('register-form').onsubmit = function(e) {
      e.preventDefault();
      const domain = document.getElementById('reg-domain').value.trim().toLowerCase();
      const html = document.getElementById('reg-html').value;
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      const file = new File([html], "index.html", { type: "text/html" });
      client.seed(file, torrent => {
        setDomainOwner(domain, myMAC);
        saveMagnet(myMAC, torrent.magnetURI);
        addMirror(domain, myMAC);
        alert(`Registered ${domain}, now seeding via WebTorrent!\nMagnet: ${torrent.magnetURI}`);
      });
    };

    // Mirroring logic: seed HTML and register as mirror
    function mirrorSite(domain, html) {
      const file = new File([html], "index.html", { type: "text/html" });
      client.seed(file, torrent => {
        saveMagnet(myMAC, torrent.magnetURI);
        addMirror(domain, myMAC);
        alert('You are now mirroring this site via WebTorrent!\nMagnet: ' + torrent.magnetURI);
      });
    }

    // Load a .lunar domain: try owner, then mirrors
    document.getElementById('domain-form').onsubmit = function(e) {
      e.preventDefault();
      const domain = document.getElementById('domain-input').value.trim().toLowerCase();
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      document.getElementById('site-viewer').innerHTML = 'Loading...';
      getDomainOwner(domain, mac => {
        if (mac) {
          loadMagnet(mac, magnet => {
            if (magnet) {
              fetchAndShow(domain, magnet, mac, true);
            } else {
              tryMirrors(domain, mac);
            }
          });
        } else {
          tryMirrors(domain, null);
        }
      });
    };

    function tryMirrors(domain, excludeMac) {
      getMirrors(domain, macs => {
        if (excludeMac) macs = macs.filter(mac => mac !== excludeMac);
        if (macs.length === 0) {
          document.getElementById('site-viewer').innerHTML =
            `<p>No .lunar site registered for <b>${domain}</b> and no mirrors found.</p>`;
          return;
        }
        let found = false, i = 0;
        function tryNext() {
          if (i >= macs.length) {
            if (!found) {
              document.getElementById('site-viewer').innerHTML =
                `<p>Mirrors found for <b>${domain}</b>, but none have the site content.</p>`;
            }
            return;
          }
          const mac = macs[i++];
          loadMagnet(mac, magnet => {
            if (magnet) {
              fetchAndShow(domain, magnet, mac, false, true);
              found = true;
            } else {
              tryNext();
            }
          });
        }
        tryNext();
      });
    }

    // Fetch HTML via WebTorrent and display in iframe + provide new tab proxy
    function fetchAndShow(domain, magnet, mac, isOwner, isMirror) {
      document.getElementById('site-viewer').innerHTML = 'Fetching HTML via WebTorrent...';
      client.add(magnet, torrent => {
        const htmlFile = torrent.files.find(f => f.name.endsWith('.html'));
        if (!htmlFile) {
          document.getElementById('site-viewer').innerHTML =
            `<p>Peer found, but no HTML file in torrent!</p>`;
          return;
        }
        htmlFile.getBlobURL((err, url) => {
          if (err) {
            document.getElementById('site-viewer').innerHTML = `<p>Error loading site: ${err}</p>`;
            return;
          }
          htmlFile.getBlob((err, blob) => {
            if (err) {
              document.getElementById('site-viewer').innerHTML =
                `<p>Error loading site: ${err}</p>`;
              return;
            }
            // Button to open in a new tab
            const openNewTabHandler = () => {
              const blobUrl = URL.createObjectURL(blob);
              const viewerBlob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                  <meta charset="utf-8">
                  <title>${domain}</title>
                  <style>body {margin:0;} iframe {width:100vw; height:100vh; border:none;}</style>
                </head>
                <body>
                  <iframe src="${blobUrl}" sandbox="allow-scripts allow-same-origin"></iframe>
                </body>
                </html>
              `], {type: "text/html"});
              const viewerUrl = URL.createObjectURL(viewerBlob);
              window.open(viewerUrl, '_blank');
            };

            document.getElementById('site-viewer').innerHTML =
              `<iframe sandbox="allow-scripts allow-same-origin" src="${url}"></iframe>
              <div class="info">${isOwner ? 'Loaded from owner: ' : 'Loaded from mirror: '}${mac}</div>
              <button id="open-newtab-btn">Open .lunar site in new tab</button>
              ${isOwner || isMirror ? '' :
                `<button id="mirror-btn">Mirror this site</button>
                 <div class="info">Help keep this site alive by mirroring it.</div>`}`;
            document.getElementById('open-newtab-btn').onclick = openNewTabHandler;
            if (!isOwner && !isMirror) {
              document.getElementById('mirror-btn').onclick = function() {
                // Download HTML as text and seed as new mirror
                htmlFile.getBlob((err, blob2) => {
                  if (err) return alert('Error downloading: ' + err);
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    mirrorSite(domain, e.target.result);
                  };
                  reader.readAsText(blob2);
                });
              };
            }
          });
        });
      });
    }
  </script>
</body>
</html>
