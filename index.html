<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LunarDomain: Decentralized .lunar Sites (IPFS + Blockchain)</title>
  <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body { font-family: monospace; background: #111; color: #fff; }
    input, button, textarea { font-size: 1em; }
    #register-form, #site-viewer { margin-top: 2em; background: #222; padding: 1em; border-radius: 8px; }
    .info { color: #aaa; font-size: small; }
    iframe { width: 100%; height: 400px; border: none; background: #fff; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ LunarDomain .lunar (IPFS + Blockchain)</h1>
  <form id="domain-form">
    <input id="domain-input" placeholder="Enter .lunar domain (e.g. mysite.lunar)" required />
    <button type="submit">Visit</button>
  </form>
  <div id="site-viewer">Enter a .lunar domain to get started.</div>
  <form id="register-form">
    <h3>Register your .lunar domain</h3>
    <input id="reg-domain" placeholder="mysite.lunar" required />
    <textarea id="reg-html" placeholder="Your site HTML" required style="width:100%;height:100px;"></textarea><br>
    <button type="submit">Publish</button>
    <div class="info">Site HTML is stored on IPFS. The blockchain stores your domainâ†’IPFS address mapping.<br>(No coins, just decentralized mapping!)</div>
  </form>
  <div class="info" style="margin-top:2em;">
    <b>How it works:</b> Register a domain, upload your HTML to IPFS, and store the mapping on the blockchain (GunDB for demo). Anyone can look up the domain and fetch your site from IPFS.<br>
    <b>For a real blockchain, swap GunDB for smart contract calls.</b>
  </div>
  <script>
    // GUN as our demo "blockchain" (replace with real smart contract for production)
    const gun = Gun();

    // IPFS node
    let ipfs;
    (async () => {
      ipfs = await window.Ipfs.create();
      console.log("IPFS node started");
    })();

    // "Blockchain": domain -> CID mapping
    function setDomainCID(domain, cid) {
      gun.get('lunar_blockchain').get(domain).put({ cid: cid });
    }
    function getDomainCID(domain, cb) {
      gun.get('lunar_blockchain').get(domain).once(data => cb(data ? data.cid : null));
    }

    // Register and upload site
    document.getElementById('register-form').onsubmit = async function(e) {
      e.preventDefault();
      const domain = document.getElementById('reg-domain').value.trim().toLowerCase();
      const html = document.getElementById('reg-html').value;
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      if (!ipfs) {
        alert('IPFS node is still starting...');
        return;
      }
      // Add HTML to IPFS
      const { cid } = await ipfs.add({ path: 'index.html', content: html });
      setDomainCID(domain, cid.toString());
      alert(`Site published! Domain: ${domain} â†’ IPFS CID: ${cid}`);
    };

    // Visit domain
    document.getElementById('domain-form').onsubmit = function(e) {
      e.preventDefault();
      const domain = document.getElementById('domain-input').value.trim().toLowerCase();
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      document.getElementById('site-viewer').innerHTML = 'Looking up domain on blockchain...';
      getDomainCID(domain, async cid => {
        if (!cid) {
          document.getElementById('site-viewer').innerHTML = `<p>No .lunar site registered for <b>${domain}</b>.</p>`;
          return;
        }
        document.getElementById('site-viewer').innerHTML = `Loading site from IPFS (${cid})...`;
        try {
          // Fetch file from IPFS
          let html = "";
          for await (const chunk of ipfs.cat(cid)) {
            html += new TextDecoder().decode(chunk);
          }
          // Open in a sandboxed iframe
          const blobUrl = URL.createObjectURL(new Blob([html], {type: "text/html"}));
          document.getElementById('site-viewer').innerHTML = `
            <iframe src="${blobUrl}" sandbox="allow-scripts allow-same-origin"></iframe>
            <div class="info">Loaded from IPFS CID: ${cid}</div>
            <a href="https://ipfs.io/ipfs/${cid}" target="_blank">View raw on IPFS gateway</a>
          `;
        } catch (err) {
          document.getElementById('site-viewer').innerHTML = `<p>Error loading from IPFS: ${err}</p>`;
        }
      });
    };
  </script>
</body>
</html>
