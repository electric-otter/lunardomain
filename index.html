<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LunarDomain: Decentralized .lunar Sites</title>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body { font-family: monospace; background: #111; color: #fff; }
    input, button, textarea { font-size: 1em; }
    #register-form { margin-top: 2em; background: #222; padding: 1em; border-radius: 8px; }
    a, a:visited { color: #89f; }
    .info { color: #aaa; font-size: small; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ LunarDomain .lunar with WebTorrent</h1>
  <form id="domain-form">
    <input id="domain-input" placeholder="Enter .lunar domain (e.g. mysite.lunar)" required />
    <button type="submit">Visit</button>
  </form>
  <div class="info" style="margin-top:2em;">
    <b>How it works:</b> When you register, your HTML is seeded as a WebTorrent and the magnet URI is published to GUN. Visitors fetch your HTML via WebTorrent. Anyone can "mirror" a site, seeding it themselves and adding their magnet link as a mirror.<br>
    <b>Now, when you visit a .lunar domain, the site will instantly open in a new tab!</b>
  </div>
  <form id="register-form">
    <h3>Register your .lunar domain</h3>
    <input id="reg-domain" placeholder="mysite.lunar" required />
    <textarea id="reg-html" placeholder="Your site HTML" required style="width:100%;height:100px;"></textarea><br>
    <button type="submit">Register</button>
    <div class="info">(This seeds your site HTML via WebTorrent and maps your .lunar domain to your magnet URI. Others will fetch your HTML via WebTorrent!)</div>
  </form>
  <script>
    // GUN for lightweight metadata (magnet URIs, mirrors)
    const gun = Gun();

    // Generate a pseudo-MAC/peer ID for this device (browser-unique)
    function getPseudoMAC() {
      let mac = localStorage.getItem('pseudo_mac');
      if (!mac) {
        mac = 'MAC-' + Math.random().toString(36).substr(2,12);
        localStorage.setItem('pseudo_mac', mac);
      }
      return mac;
    }
    const myMAC = getPseudoMAC();

    // WebTorrent client
    const client = new WebTorrent();

    // Map domain -> owner MAC
    function setDomainOwner(domain, mac) {
      gun.get('lunar_domains').get(domain).put({ mac });
    }
    function getDomainOwner(domain, cb) {
      gun.get('lunar_domains').get(domain).once(data => cb(data ? data.mac : null));
    }

    // Map MAC -> magnet URI
    function saveMagnet(mac, magnet) {
      gun.get('lunar_uris').get(mac).put({ magnet });
    }
    function loadMagnet(mac, cb) {
      gun.get('lunar_uris').get(mac).once(data => cb(data ? data.magnet : null));
    }

    // Mirroring: domain -> set of MACs
    function addMirror(domain, mac) {
      gun.get('lunar_mirrors').get(domain).get(mac).put(true);
    }
    function getMirrors(domain, cb) {
      gun.get('lunar_mirrors').get(domain).once(data => {
        if (!data) return cb([]);
        const macs = Object.keys(data).filter(k => data[k] === true && !k.startsWith('_'));
        cb(macs);
      });
    }

    // Register domain handler, and seed HTML as torrent
    document.getElementById('register-form').onsubmit = function(e) {
      e.preventDefault();
      const domain = document.getElementById('reg-domain').value.trim().toLowerCase();
      const html = document.getElementById('reg-html').value;
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      const file = new File([html], "index.html", { type: "text/html" });
      // Prevent duplicate seed error
      let infoHash;
      const tmpClient = new WebTorrent();
      tmpClient.seed(file, { announce: [] }, torrent => {
        infoHash = torrent.infoHash;
        tmpClient.destroy();
        if (!client.get(infoHash)) {
          client.seed(file, t => {
            setDomainOwner(domain, myMAC);
            saveMagnet(myMAC, t.magnetURI);
            addMirror(domain, myMAC);
            alert(`Registered ${domain}, now seeding via WebTorrent!\nMagnet: ${t.magnetURI}`);
          });
        } else {
          setDomainOwner(domain, myMAC);
          saveMagnet(myMAC, client.get(infoHash).magnetURI);
          addMirror(domain, myMAC);
          alert(`Registered ${domain}, already seeding via WebTorrent!`);
        }
      });
    };

    // Mirroring logic: seed HTML and register as mirror (also prevents duplicate)
    function mirrorSite(domain, html) {
      const file = new File([html], "index.html", { type: "text/html" });
      let infoHash;
      const tmpClient = new WebTorrent();
      tmpClient.seed(file, { announce: [] }, torrent => {
        infoHash = torrent.infoHash;
        tmpClient.destroy();
        if (!client.get(infoHash)) {
          client.seed(file, t => {
            saveMagnet(myMAC, t.magnetURI);
            addMirror(domain, myMAC);
            alert('You are now mirroring this site via WebTorrent!\nMagnet: ' + t.magnetURI);
          });
        } else {
          saveMagnet(myMAC, client.get(infoHash).magnetURI);
          addMirror(domain, myMAC);
          alert('You are now mirroring this site via WebTorrent!');
        }
      });
    }

    document.getElementById('domain-form').onsubmit = function(e) {
      e.preventDefault();
      const domain = document.getElementById('domain-input').value.trim().toLowerCase();
      if (!domain.endsWith('.lunar')) {
        alert('Only .lunar domains are supported.');
        return;
      }
      getDomainOwner(domain, mac => {
        if (mac) {
          loadMagnet(mac, magnet => {
            if (magnet) {
              fetchAndOpenNewTab(domain, magnet, mac, true);
            } else {
              tryMirrors(domain, mac);
            }
          });
        } else {
          tryMirrors(domain, null);
        }
      });
    };

    function tryMirrors(domain, excludeMac) {
      getMirrors(domain, macs => {
        if (excludeMac) macs = macs.filter(mac => mac !== excludeMac);
        if (macs.length === 0) {
          alert(`No .lunar site registered for ${domain} and no mirrors found.`);
          return;
        }
        let found = false, i = 0;
        function tryNext() {
          if (i >= macs.length) {
            if (!found) alert(`Mirrors found for ${domain}, but none have the site content.`);
            return;
          }
          const mac = macs[i++];
          loadMagnet(mac, magnet => {
            if (magnet) {
              fetchAndOpenNewTab(domain, magnet, mac, false, true);
              found = true;
            } else {
              tryNext();
            }
          });
        }
        tryNext();
      });
    }

    // Fetch HTML via WebTorrent and open in new tab (no iframe in current page)
    function fetchAndOpenNewTab(domain, magnet, mac, isOwner, isMirror) {
      let infoHash = /btih:([a-fA-F0-9]{40,})/.exec(magnet);
      infoHash = infoHash ? infoHash[1].toLowerCase() : null;
      if (client.get(infoHash)) {
        // Already added, use existing torrent
        useTorrent(client.get(infoHash));
      } else {
        client.add(magnet, useTorrent);
      }
      function useTorrent(torrent) {
        const htmlFile = torrent.files.find(f => f.name.endsWith('.html'));
        if (!htmlFile) {
          alert('Peer found, but no HTML file in torrent!');
          return;
        }
        htmlFile.getBlob((err, blob) => {
          if (err) {
            alert('Error loading site: ' + err);
            return;
          }
          // Create a new viewer page as a Blob and open it
          const blobUrl = URL.createObjectURL(blob);
          const viewerHtml = `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>${domain}</title>
              <style>body {margin:0;} iframe {width:100vw; height:100vh; border:none;}</style>
            </head>
            <body>
              <iframe src="${blobUrl}" sandbox="allow-scripts allow-same-origin"></iframe>
            </body>
            </html>
          `;
          const viewerBlob = new Blob([viewerHtml], {type: "text/html"});
          const viewerUrl = URL.createObjectURL(viewerBlob);
          window.open(viewerUrl, '_blank');
        });
      }
    }
  </script>
</body>
</html>
